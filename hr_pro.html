<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الحضور والرواتب</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- إضافة Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --sidebar-width: 260px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            font-size: 14px;
        }
        
        .container {
            max-width: 100%;
            padding: 15px;
            transition: margin-right 0.3s ease;
        }
        
        /* الشريط الجانبي */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
            color: white;
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease, width 0.3s ease;
            z-index: 1000;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        .sidebar-header {
            padding: 20px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h2 {
            font-size: 1.2rem;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .close-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-menu li {
            margin: 5px 0;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            border-right: 3px solid transparent;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-right-color: white;
        }
        
        .sidebar-menu i {
            margin-left: 10px;
            font-size: 1.1rem;
            min-width: 20px;
            text-align: center;
        }
        
        .sidebar-menu span {
            white-space: nowrap;
            overflow: hidden;
        }
        
        /* زر القائمة للهواتف المحمولة */
        .mobile-menu-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            font-size: 1.2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .mobile-menu-toggle:hover {
            background: var(--secondary-color);
            transform: scale(1.05);
        }
        
        /* طبقة التعتيم عند فتح الشريط الجانبي */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 998;
            display: none;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        /* تحسينات للشاشات الكبيرة */
        @media (min-width: 769px) {
            .container {
                margin-right: var(--sidebar-width);
                padding-right: 20px;
            }
            
            .sidebar {
                transform: translateX(0);
                width: var(--sidebar-width);
            }
            
            .mobile-menu-toggle {
                display: none;
            }
            
            .sidebar-overlay {
                display: none !important;
            }
            
            .close-sidebar {
                display: none;
            }
        }
        
        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 768px) {
            .sidebar {
                width: 85%;
                max-width: 300px;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                width: 90%;
            }
            
            .mobile-menu-toggle {
                top: 10px;
                right: 10px;
                width: 45px;
                height: 45px;
            }
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 0;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
        }
        
        h3 {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: var(--dark-color);
            font-size: 0.9rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
            margin: 5px;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-excel {
            background-color: #1d6f42;
        }
        
        .btn-excel:hover {
            background-color: #155d33;
        }
        
        .btn-whatsapp {
            background-color: #25D366;
        }
        
        .btn-whatsapp:hover {
            background-color: #128C7E;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85rem;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light-color);
            font-weight: bold;
            color: var(--dark-color);
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 8px 0;
        }
        
        .presence { color: var(--success-color); }
        .absence { color: var(--danger-color); }
        .vacation { color: var(--warning-color); }
        .advance { color: #9b59b6; }
        .bonus { color: #1abc9c; }
        .expenses { color: #e67e22; }
        .deduction { color: #e74c3c; }
        
        .report-section {
            margin-bottom: 20px;
        }
        
        .employee-report {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .summary {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .alert {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .export-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .salary-calculation {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-right: 4px solid var(--primary-color);
        }
        
        .salary-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .salary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
        }
        
        .salary-total {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid var(--primary-color);
        }
        
        .cash-balance {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .cash-balance h3 {
            color: white;
            margin-bottom: 10px;
        }
        
        .cash-balance .amount {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .transaction-history {
            margin-top: 20px;
        }
        
        .finance-reports {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--primary-color);
        }
        
        /* أنماط الصفحة الرئيسية */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .dashboard-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .dashboard-card i {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .dashboard-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .dashboard-card .label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .card-employees { border-top: 4px solid #3498db; }
        .card-attendance { border-top: 4px solid #2ecc71; }
        .card-vacation { border-top: 4px solid #f39c12; }
        .card-advance { border-top: 4px solid #9b59b6; }
        .card-bonus { border-top: 4px solid #1abc9c; }
        .card-deduction { border-top: 4px solid #e74c3c; }
        .card-expenses { border-top: 4px solid #e67e22; }
        .card-cash { border-top: 4px solid #34495e; }
        
        .filters {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .dashboard-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .action-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }
        
        .action-card:hover {
            background-color: #e9ecef;
            transform: translateY(-3px);
        }
        
        .action-card i {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #3498db;
        }
        
        .recent-activity {
            margin-top: 20px;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e3f2fd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
        }
        
        .activity-icon i {
            color: #3498db;
        }
        
        .activity-details {
            flex: 1;
        }
        
        .activity-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .activity-date {
            color: #666;
            font-size: 0.85rem;
        }
        
        .no-print {
            /* إخفاء العناصر عند الطباعة */
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
        }
        
        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
            }
            
            .dashboard-card {
                padding: 15px;
            }
            
            .dashboard-card .value {
                font-size: 1.5rem;
            }
            
            .filters-row {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
        }
        
        /* إضافة أنماط جديدة */
        .attendance-days {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .whatsapp-btn {
            background-color: #25D366;
        }
        
        .whatsapp-btn:hover {
            background-color: #128C7E;
        }
        
        .send-report-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .send-report-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- زر القائمة للهواتف المحمولة -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- طبقة التعتيم -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- الشريط الجانبي -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>نظام الإدارة</h2>
            <button class="close-sidebar" id="closeSidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="active" data-tab="dashboard"><i class="fas fa-home"></i><span>الصفحة الرئيسية</span></a></li>
            <li><a href="#" data-tab="employees"><i class="fas fa-users"></i><span>الموظفين</span></a></li>
            <li><a href="#" data-tab="attendance"><i class="fas fa-calendar-check"></i><span>تسجيل الحضور</span></a></li>
            <li><a href="#" data-tab="vacation"><i class="fas fa-umbrella-beach"></i><span>الإجازات</span></a></li>
            <li><a href="#" data-tab="advance"><i class="fas fa-hand-holding-usd"></i><span>السلف</span></a></li>
            <li><a href="#" data-tab="bonus"><i class="fas fa-gift"></i><span>المكافآت</span></a></li>
            <li><a href="#" data-tab="deduction"><i class="fas fa-minus-circle"></i><span>الخصومات</span></a></li>
            <li><a href="#" data-tab="expenses"><i class="fas fa-receipt"></i><span>المصروفات</span></a></li>
            <li><a href="#" data-tab="cash"><i class="fas fa-piggy-bank"></i><span>خزينة العهدة</span></a></li>
            <li><a href="#" data-tab="finance-reports"><i class="fas fa-chart-line"></i><span>تقارير مالية</span></a></li>
            <li><a href="#" data-tab="report"><i class="fas fa-file-invoice-dollar"></i><span>تقرير الرواتب</span></a></li>
        </ul>
    </div>

    <!-- المحتوى الرئيسي -->
    <div class="container">
        <header>
            <h1>نظام إدارة الحضور والرواتب</h1>
            <p>إدارة الحضور والغياب والإجازات والسلف والمكافآت والخصومات والمصروفات وخزينة العهدة</p>
        </header>
        
        <!-- الصفحة الرئيسية -->
        <div id="dashboard" class="tab-content active">
            <h2>الصفحة الرئيسية</h2>
            
            <!-- الفلاتر -->
            <div class="filters">
                <h3>فلاتر البيانات</h3>
                <div class="filters-row">
                    <div class="filter-group">
                        <label for="dashboardDateFrom">من تاريخ</label>
                        <input type="date" id="dashboardDateFrom">
                    </div>
                    <div class="filter-group">
                        <label for="dashboardDateTo">إلى تاريخ</label>
                        <input type="date" id="dashboardDateTo">
                    </div>
                    <div class="filter-group">
                        <label for="dashboardEmployee">الموظف</label>
                        <select id="dashboardEmployee">
                            <option value="">جميع الموظفين</option>
                        </select>
                    </div>
                </div>
                <div class="filters-row">
                    <div class="filter-group">
                        <button onclick="applyDashboardFilters()" class="btn-success">تطبيق الفلاتر</button>
                        <button onclick="resetDashboardFilters()" class="btn-danger">إعادة التعيين</button>
                        <button onclick="exportDashboardToExcel()" class="btn-excel">تصدير البيانات إلى Excel</button>
                    </div>
                </div>
            </div>
            
            <!-- الإحصائيات -->
            <div class="dashboard">
                <div class="dashboard-card card-employees">
                    <i class="fas fa-users"></i>
                    <div class="value" id="totalEmployees">0</div>
                    <div class="label">إجمالي الموظفين</div>
                </div>
                <div class="dashboard-card card-attendance">
                    <i class="fas fa-calendar-check"></i>
                    <div class="value" id="totalAttendance">0</div>
                    <div class="label">إجمالي سجلات الحضور</div>
                </div>
                <div class="dashboard-card card-vacation">
                    <i class="fas fa-umbrella-beach"></i>
                    <div class="value" id="totalVacations">0</div>
                    <div class="label">إجمالي الإجازات</div>
                </div>
                <div class="dashboard-card card-advance">
                    <i class="fas fa-hand-holding-usd"></i>
                    <div class="value" id="totalAdvances">0</div>
                    <div class="label">إجمالي السلف</div>
                </div>
                <div class="dashboard-card card-bonus">
                    <i class="fas fa-gift"></i>
                    <div class="value" id="totalBonuses">0</div>
                    <div class="label">إجمالي المكافآت</div>
                </div>
                <div class="dashboard-card card-deduction">
                    <i class="fas fa-minus-circle"></i>
                    <div class="value" id="totalDeductions">0</div>
                    <div class="label">إجمالي الخصومات</div>
                </div>
                <div class="dashboard-card card-expenses">
                    <i class="fas fa-receipt"></i>
                    <div class="value" id="totalExpenses">0</div>
                    <div class="label">إجمالي المصروفات</div>
                </div>
                <div class="dashboard-card card-cash">
                    <i class="fas fa-piggy-bank"></i>
                    <div class="value" id="cashBalance">0.00</div>
                    <div class="label">رصيد الخزينة الحالي</div>
                </div>
            </div>
            
            <!-- إحصائيات الحضور للموظف المحدد -->
            <div class="dashboard-section" id="employeeAttendanceStats" style="display: none;">
                <div class="section-header">
                    <div class="section-title">إحصائيات الحضور للموظف المحدد</div>
                </div>
                <div class="stats-container" id="employeeAttendanceDetails">
                    <!-- سيتم ملؤها بالبيانات -->
                </div>
            </div>
            
            <!-- إرسال التقارير الشهرية -->
            <div class="send-report-section">
                <div class="section-header">
                    <div class="section-title">إرسال التقارير الشهرية للموظفين</div>
                </div>
                <p>يمكنك إرسال تقرير شامل لكل موظف يحتوي على جميع متعلقاته من حضور وغياب وإجازات ومرتب وخصومات ومكافآت عبر واتساب.</p>
                
                <div class="form-group">
                    <label for="reportMonthSend">اختر الشهر</label>
                    <input type="month" id="reportMonthSend" required>
                </div>
                
                <div class="send-report-buttons">
                    <button class="btn-success" onclick="sendReportsToAllEmployees()">
                        <i class="fab fa-whatsapp"></i> إرسال التقارير لجميع الموظفين
                    </button>
                    <button class="btn-whatsapp" onclick="sendReportToSelectedEmployee()">
                        <i class="fab fa-whatsapp"></i> إرسال تقرير للموظف المحدد
                    </button>
                </div>
            </div>
            
            <!-- الإجراءات السريعة -->
            <div class="dashboard-section">
                <div class="section-header">
                    <div class="section-title">الإجراءات السريعة</div>
                </div>
                <div class="quick-actions">
                    <div class="action-card" onclick="showTab('employees')">
                        <i class="fas fa-user-plus"></i>
                        <div>إضافة موظف جديد</div>
                    </div>
                    <div class="action-card" onclick="showTab('attendance')">
                        <i class="fas fa-calendar-plus"></i>
                        <div>تسجيل حضور/غياب</div>
                    </div>
                    <div class="action-card" onclick="showTab('vacation')">
                        <i class="fas fa-plane"></i>
                        <div>تسجيل إجازة</div>
                    </div>
                    <div class="action-card" onclick="showTab('advance')">
                        <i class="fas fa-money-bill-wave"></i>
                        <div>تسجيل سلفة</div>
                    </div>
                    <div class="action-card" onclick="showTab('expenses')">
                        <i class="fas fa-receipt"></i>
                        <div>تسجيل مصروف</div>
                    </div>
                    <div class="action-card" onclick="showTab('report')">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <div>إنشاء تقرير الرواتب</div>
                    </div>
                </div>
            </div>
            
            <!-- النشاط الأخير -->
            <div class="dashboard-section">
                <div class="section-header">
                    <div class="section-title">آخر النشاطات</div>
                </div>
                <div class="recent-activity" id="recentActivity">
                    <!-- سيتم ملؤها بالبيانات -->
                </div>
            </div>
        </div>
        
        <!-- إدارة الموظفين -->
        <div id="employees" class="tab-content">
            <h2>إدارة بيانات الموظفين</h2>
            <form id="employeeForm">
                <div class="form-group">
                    <label for="employeeName">اسم الموظف</label>
                    <input type="text" id="employeeName" required placeholder="أدخل اسم الموظف">
                </div>
                
                <div class="form-group">
                    <label for="employeePhone">رقم الجوال</label>
                    <input type="tel" id="employeePhone" required placeholder="أدخل رقم الجوال">
                </div>
                
                <div class="form-group">
                    <label for="employeePosition">الوظيفة</label>
                    <input type="text" id="employeePosition" required placeholder="أدخل الوظيفة">
                </div>
                
                <div class="form-group">
                    <label for="employeeSalary">الراتب الشهري</label>
                    <input type="number" id="employeeSalary" required placeholder="أدخل الراتب الشهري">
                </div>
                
                <div class="form-group">
                    <label for="workingDays">عدد أيام العمل في الشهر</label>
                    <input type="number" id="workingDays" required value="26" placeholder="عدد أيام العمل في الشهر">
                </div>
                
                <div class="form-group">
                    <label for="vacationDays">عدد أيام الإجازة الشهرية</label>
                    <input type="number" id="vacationDays" required value="4" placeholder="عدد أيام الإجازة الشهرية">
                </div>
                
                <button type="submit">حفظ</button>
                <button type="button" id="cancelEditEmployee" class="btn-danger" style="display:none;">إلغاء التعديل</button>
            </form>
            
            <div class="export-buttons no-print">
                <button class="btn-excel" onclick="exportEmployeesToExcel()">تصدير بيانات الموظفين إلى Excel</button>
            </div>
            
            <h3>قائمة الموظفين</h3>
            <div class="table-container">
                <table id="employeesTable">
                    <thead>
                        <tr>
                            <th>اسم الموظف</th>
                            <th>رقم الجوال</th>
                            <th>الوظيفة</th>
                            <th>الراتب</th>
                            <th>أيام العمل</th>
                            <th>أيام الإجازة</th>
                            <th class="no-print">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="employeesList">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- تسجيل الحضور -->
        <div id="attendance" class="tab-content">
            <h2>تسجيل الحضور والغياب</h2>
            <form id="attendanceForm">
                <div class="form-group">
                    <label for="attendanceDate">التاريخ</label>
                    <input type="date" id="attendanceDate" required>
                </div>
                
                <div class="form-group">
                    <label for="employeeSelect">اسم الموظف</label>
                    <select id="employeeSelect" required>
                        <option value="">اختر الموظف</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="attendanceStatus">الحالة</label>
                    <select id="attendanceStatus" required>
                        <option value="">اختر الحالة</option>
                        <option value="حضور">حضور</option>
                        <option value="غياب">غياب</option>
                        <option value="إجازة">إجازة</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="notes">ملاحظات (اختياري)</label>
                    <textarea id="notes" rows="3" placeholder="أي ملاحظات إضافية"></textarea>
                </div>
                
                <button type="submit">حفظ</button>
                <button type="button" id="cancelEditAttendance" class="btn-danger" style="display:none;">إلغاء التعديل</button>
            </form>
            
            <div class="export-buttons no-print">
                <button class="btn-excel" onclick="exportToExcel('attendanceTable', 'سجل_الحضور')">تصدير إلى Excel</button>
            </div>
            
            <h3>سجل الحضور</h3>
            <div class="table-container">
                <table id="attendanceTable">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>اسم الموظف</th>
                            <th>الحالة</th>
                            <th>ملاحظات</th>
                            <th class="no-print">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceList">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- الإجازات -->
        <div id="vacation" class="tab-content">
            <h2>تسجيل الإجازات</h2>
            <form id="vacationForm">
                <div class="form-group">
                    <label for="vacationEmployee">اسم الموظف</label>
                    <select id="vacationEmployee" required>
                        <option value="">اختر الموظف</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="vacationStart">تاريخ بداية الإجازة</label>
                    <input type="date" id="vacationStart" required>
                </div>
                
                <div class="form-group">
                    <label for="vacationEnd">تاريخ نهاية الإجازة</label>
                    <input type="date" id="vacationEnd" required>
                </div>
                
                <div class="form-group">
                    <label for="vacationType">نوع الإجازة</label>
                    <select id="vacationType" required>
                        <option value="">اختر نوع الإجازة</option>
                        <option value="إجازة سنوية">إجازة سنوية</option>
                        <option value="إجازة مرضية">إجازة مرضية</option>
                        <option value="إجازة عارضة">إجازة عارضة</option>
                        <option value="إجازة رسمية">إجازة رسمية</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="vacationNotes">ملاحظات (اختياري)</label>
                    <textarea id="vacationNotes" rows="3" placeholder="أي ملاحظات إضافية"></textarea>
                </div>
                
                <button type="submit">حفظ</button>
                <button type="button" id="cancelEditVacation" class="btn-danger" style="display:none;">إلغاء التعديل</button>
            </form>
            
            <div class="export-buttons no-print">
                <button class="btn-excel" onclick="exportToExcel('vacationTable', 'سجل_الإجازات')">تصدير إلى Excel</button>
            </div>
            
            <h3>سجل الإجازات</h3>
            <div class="table-container">
                <table id="vacationTable">
                    <thead>
                        <tr>
                            <th>اسم الموظف</th>
                            <th>من تاريخ</th>
                            <th>إلى تاريخ</th>
                            <th>نوع الإجازة</th>
                            <th>ملاحظات</th>
                            <th class="no-print">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="vacationList">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- السلف -->
        <div id="advance" class="tab-content">
            <h2>تسجيل السلف</h2>
            <form id="advanceForm">
                <div class="form-group">
                    <label for="advanceEmployee">اسم الموظف</label>
                    <select id="advanceEmployee" required>
                        <option value="">اختر الموظف</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="advanceDate">التاريخ</label>
                    <input type="date" id="advanceDate" required>
                </div>
                
                <div class="form-group">
                    <label for="advanceAmount">المبلغ</label>
                    <input type="number" id="advanceAmount" required placeholder="أدخل المبلغ">
                </div>
                
                <div class="form-group">
                    <label for="advanceReason">السبب (اختياري)</label>
                    <textarea id="advanceReason" rows="3" placeholder="سبب السلفة"></textarea>
                </div>
                
                <button type="submit">حفظ</button>
                <button type="button" id="cancelEditAdvance" class="btn-danger" style="display:none;">إلغاء التعديل</button>
            </form>
            
            <div class="export-buttons no-print">
                <button class="btn-excel" onclick="exportToExcel('advanceTable', 'سجل_السلف')">تصدير إلى Excel</button>
            </div>
            
            <h3>سجل السلف</h3>
            <div class="table-container">
                <table id="advanceTable">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>اسم الموظف</th>
                            <th>المبلغ</th>
                            <th>السبب</th>
                            <th class="no-print">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="advanceList">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- المكافآت -->
        <div id="bonus" class="tab-content">
            <h2>تسجيل المكافآت</h2>
            <form id="bonusForm">
                <div class="form-group">
                    <label for="bonusEmployee">اسم الموظف</label>
                    <select id="bonusEmployee" required>
                        <option value="">اختر الموظف</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="bonusDate">التاريخ</label>
                    <input type="date" id="bonusDate" required>
                </div>
                
                <div class="form-group">
                    <label for="bonusAmount">المبلغ</label>
                    <input type="number" id="bonusAmount" required placeholder="أدخل المبلغ">
                </div>
                
                <div class="form-group">
                    <label for="bonusReason">السبب (اختياري)</label>
                    <textarea id="bonusReason" rows="3" placeholder="سبب المكافأة"></textarea>
                </div>
                
                <button type="submit">حفظ</button>
                <button type="button" id="cancelEditBonus" class="btn-danger" style="display:none;">إلغاء التعديل</button>
            </form>
            
            <div class="export-buttons no-print">
                <button class="btn-excel" onclick="exportToExcel('bonusTable', 'سجل_المكافآت')">تصدير إلى Excel</button>
            </div>
            
            <h3>سجل المكافآت</h3>
            <div class="table-container">
                <table id="bonusTable">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>اسم الموظف</th>
                            <th>المبلغ</th>
                            <th>السبب</th>
                            <th class="no-print">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="bonusList">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- الخصومات -->
        <div id="deduction" class="tab-content">
            <h2>تسجيل الخصومات</h2>
            <form id="deductionForm">
                <div class="form-group">
                    <label for="deductionEmployee">اسم الموظف</label>
                    <select id="deductionEmployee" required>
                        <option value="">اختر الموظف</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="deductionDate">التاريخ</label>
                    <input type="date" id="deductionDate" required>
                </div>
                
                <div class="form-group">
                    <label for="deductionAmount">المبلغ</label>
                    <input type="number" id="deductionAmount" required placeholder="أدخل المبلغ">
                </div>
                
                <div class="form-group">
                    <label for="deductionReason">السبب</label>
                    <select id="deductionReason" required>
                        <option value="">اختر سبب الخصم</option>
                        <option value="تأخير">تأخير</option>
                        <option value="غياب">غياب</option>
                        <option value="مخالفة">مخالفة</option>
                        <option value="تأمينات">تأمينات</option>
                        <option value="ضرائب">ضرائب</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="deductionNotes">ملاحظات (اختياري)</label>
                    <textarea id="deductionNotes" rows="3" placeholder="أي ملاحظات إضافية"></textarea>
                </div>
                
                <button type="submit">حفظ</button>
                <button type="button" id="cancelEditDeduction" class="btn-danger" style="display:none;">إلغاء التعديل</button>
            </form>
            
            <div class="export-buttons no-print">
                <button class="btn-excel" onclick="exportToExcel('deductionTable', 'سجل_الخصومات')">تصدير إلى Excel</button>
            </div>
            
            <h3>سجل الخصومات</h3>
            <div class="table-container">
                <table id="deductionTable">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>اسم الموظف</th>
                            <th>المبلغ</th>
                            <th>السبب</th>
                            <th>ملاحظات</th>
                            <th class="no-print">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="deductionList">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- المصروفات -->
        <div id="expenses" class="tab-content">
            <h2>تسجيل المصروفات</h2>
            <form id="expensesForm">
                <div class="form-group">
                    <label for="expenseDate">التاريخ</label>
                    <input type="date" id="expenseDate" required>
                </div>
                
                <div class="form-group">
                    <label for="expenseDescription">وصف المصروف</label>
                    <input type="text" id="expenseDescription" required placeholder="وصف المصروف">
                </div>
                
                <div class="form-group">
                    <label for="expenseAmount">المبلغ</label>
                    <input type="number" id="expenseAmount" required placeholder="أدخل المبلغ">
                </div>
                
                <div class="form-group">
                    <label for="expenseCategory">الفئة</label>
                    <select id="expenseCategory" required>
                        <option value="">اختر الفئة</option>
                        <option value="مصروفات مكتب">مصروفات مكتب</option>
                        <option value="مصروفات تشغيل">مصروفات تشغيل</option>
                        <option value="مصروفات أخرى">مصروفات أخرى</option>
                    </select>
                </div>
                
                <button type="submit">حفظ</button>
                <button type="button" id="cancelEditExpense" class="btn-danger" style="display:none;">إلغاء التعديل</button>
            </form>
            
            <div class="export-buttons no-print">
                <button class="btn-excel" onclick="exportToExcel('expensesTable', 'سجل_المصروفات')">تصدير إلى Excel</button>
            </div>
            
            <h3>سجل المصروفات</h3>
            <div class="table-container">
                <table id="expensesTable">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>الوصف</th>
                            <th>المبلغ</th>
                            <th>الفئة</th>
                            <th class="no-print">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="expensesList">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- خزينة العهدة -->
        <div id="cash" class="tab-content">
            <h2>إدارة خزينة العهدة</h2>
            
            <div class="cash-balance">
                <h3>الرصيد الحالي في الخزينة</h3>
                <div class="amount" id="cashBalanceAmount">0.00</div>
            </div>
            
            <div class="form-group">
                <label for="initialBalance">تعيين رصيد ابتدائي للخزينة</label>
                <input type="number" id="initialBalance" placeholder="أدخل الرصيد الابتدائي">
                <button onclick="setInitialBalance()" class="btn-success" style="margin-top: 10px;">تعيين الرصيد الابتدائي</button>
            </div>
            
            <h3>حركات الخزينة</h3>
            <form id="cashTransactionForm">
                <div class="form-group">
                    <label for="transactionDate">التاريخ</label>
                    <input type="date" id="transactionDate" required>
                </div>
                
                <div class="form-group">
                    <label for="transactionType">نوع الحركة</label>
                    <select id="transactionType" required>
                        <option value="">اختر نوع الحركة</option>
                        <option value="إيداع">إيداع</option>
                        <option value="سحب">سحب</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="transactionAmount">المبلغ</label>
                    <input type="number" id="transactionAmount" required placeholder="أدخل المبلغ">
                </div>
                
                <div class="form-group">
                    <label for="transactionDescription">الوصف</label>
                    <input type="text" id="transactionDescription" required placeholder="وصف الحركة">
                </div>
                
                <button type="submit">حفظ</button>
                <button type="button" id="cancelEditCash" class="btn-danger" style="display:none;">إلغاء التعديل</button>
            </form>
            
            <div class="export-buttons no-print">
                <button class="btn-excel" onclick="exportToExcel('cashTransactionsTable', 'سجل_حركات_الخزينة')">تصدير إلى Excel</button>
            </div>
            
            <h3>سجل حركات الخزينة</h3>
            <div class="table-container">
                <table id="cashTransactionsTable">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>نوع الحركة</th>
                            <th>المبلغ</th>
                            <th>الوصف</th>
                            <th class="no-print">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="cashTransactionsList">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- التقارير المالية -->
        <div id="finance-reports" class="tab-content">
            <h2>التقارير المالية</h2>
            
            <div class="finance-reports">
                <h3>تقارير المصروفات</h3>
                <div class="form-group">
                    <label for="expenseReportMonth">اختر الشهر</label>
                    <input type="month" id="expenseReportMonth" required>
                </div>
                
                <button onclick="generateExpenseReport()">إنشاء تقرير المصروفات</button>
                <button class="btn-excel" onclick="exportExpenseReportToExcel()">تصدير التقرير إلى Excel</button>
                
                <div id="expenseReportResults">
                    <!-- سيتم ملؤها بالبيانات -->
                </div>
            </div>
            
            <div class="finance-reports">
                <h3>تقارير الخزينة</h3>
                <div class="form-group">
                    <label for="cashReportMonth">اختر الشهر</label>
                    <input type="month" id="cashReportMonth" required>
                </div>
                
                <button onclick="generateCashReport()">إنشاء تقرير الخزينة</button>
                <button class="btn-excel" onclick="exportCashReportToExcel()">تصدير التقرير إلى Excel</button>
                
                <div id="cashReportResults">
                    <!-- سيتم ملؤها بالبيانات -->
                </div>
            </div>
        </div>
        
        <!-- تقرير نهاية الشهر -->
        <div id="report" class="tab-content">
            <h2>تقرير الرواتب الشهري</h2>
            
            <div class="form-group">
                <label for="reportMonth">اختر الشهر</label>
                <input type="month" id="reportMonth" required>
            </div>
            
            <button onclick="generateMonthlyReport()">إنشاء التقرير</button>
            <button class="btn-excel" onclick="exportReportToExcel()">تصدير التقرير إلى Excel</button>
            
            <div id="reportResults">
                <!-- سيتم ملؤها بالبيانات -->
            </div>
        </div>
    </div>

    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCJpL7YtVQvGJ3X3Q3Q3Q3Q3Q3Q3Q3Q3Q3Q",
            authDomain: "hrpro-44abc.firebaseapp.com",
            databaseURL: "https://hrpro-44abc-default-rtdb.firebaseio.com",
            projectId: "hrpro-44abc",
            storageBucket: "hrpro-44abc.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // البيانات
        let employees = [];
        let attendance = [];
        let vacations = [];
        let advances = [];
        let bonuses = [];
        let deductions = [];
        let expenses = [];
        let cashTransactions = [];
        
        // متغيرات التعديل
        let editingEmployeeId = null;
        let editingAttendanceId = null;
        let editingVacationId = null;
        let editingAdvanceId = null;
        let editingBonusId = null;
        let editingDeductionId = null;
        let editingExpenseId = null;
        let editingCashTransactionId = null;
        
        let currentReportData = [];
        let initialCashBalance = 0;

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // تعيين التاريخ الحالي كقيمة افتراضية
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            document.getElementById('vacationStart').value = today;
            document.getElementById('vacationEnd').value = today;
            document.getElementById('advanceDate').value = today;
            document.getElementById('bonusDate').value = today;
            document.getElementById('deductionDate').value = today;
            document.getElementById('expenseDate').value = today;
            document.getElementById('transactionDate').value = today;
            
            // تعيين الشهر الحالي في التقارير
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('reportMonth').value = currentMonth;
            document.getElementById('expenseReportMonth').value = currentMonth;
            document.getElementById('cashReportMonth').value = currentMonth;
            document.getElementById('reportMonthSend').value = currentMonth;
            
            // تحميل البيانات من Firebase
            loadAllData();
            
            // إعداد مستمعي الأحداث
            setupEventListeners();
            
            // تحديث قوائم الموظفين في النماذج
            updateEmployeeSelects();
            
            // تحديث جميع القوائم تلقائياً
            updateAllLists();
            
            // تحديث رصيد الخزينة
            updateCashBalance();
            
            // إدارة الشريط الجانبي
            setupSidebar();
            
            // تحديث الصفحة الرئيسية
            updateDashboard();
        });

        // تحميل البيانات من Firebase
        function loadAllData() {
            showLoading('جاري تحميل البيانات...');
            
            // تحميل الموظفين
            database.ref('employees').on('value', (snapshot) => {
                employees = [];
                snapshot.forEach((childSnapshot) => {
                    const employee = childSnapshot.val();
                    employee.id = childSnapshot.key;
                    employees.push(employee);
                });
                updateEmployeeSelects();
                updateDashboardStats();
                hideLoading();
            });

            // تحميل الحضور
            database.ref('attendance').on('value', (snapshot) => {
                attendance = [];
                snapshot.forEach((childSnapshot) => {
                    const record = childSnapshot.val();
                    record.id = childSnapshot.key;
                    attendance.push(record);
                });
                displayAttendance();
                updateDashboardStats();
            });

            // تحميل الإجازات
            database.ref('vacations').on('value', (snapshot) => {
                vacations = [];
                snapshot.forEach((childSnapshot) => {
                    const vacation = childSnapshot.val();
                    vacation.id = childSnapshot.key;
                    vacations.push(vacation);
                });
                displayVacations();
                updateDashboardStats();
            });

            // تحميل السلف
            database.ref('advances').on('value', (snapshot) => {
                advances = [];
                snapshot.forEach((childSnapshot) => {
                    const advance = childSnapshot.val();
                    advance.id = childSnapshot.key;
                    advances.push(advance);
                });
                displayAdvances();
                updateDashboardStats();
            });

            // تحميل المكافآت
            database.ref('bonuses').on('value', (snapshot) => {
                bonuses = [];
                snapshot.forEach((childSnapshot) => {
                    const bonus = childSnapshot.val();
                    bonus.id = childSnapshot.key;
                    bonuses.push(bonus);
                });
                displayBonuses();
                updateDashboardStats();
            });

            // تحميل الخصومات
            database.ref('deductions').on('value', (snapshot) => {
                deductions = [];
                snapshot.forEach((childSnapshot) => {
                    const deduction = childSnapshot.val();
                    deduction.id = childSnapshot.key;
                    deductions.push(deduction);
                });
                displayDeductions();
                updateDashboardStats();
            });

            // تحميل المصروفات
            database.ref('expenses').on('value', (snapshot) => {
                expenses = [];
                snapshot.forEach((childSnapshot) => {
                    const expense = childSnapshot.val();
                    expense.id = childSnapshot.key;
                    expenses.push(expense);
                });
                displayExpenses();
                updateDashboardStats();
            });

            // تحميل حركات الخزينة
            database.ref('cashTransactions').on('value', (snapshot) => {
                cashTransactions = [];
                snapshot.forEach((childSnapshot) => {
                    const transaction = childSnapshot.val();
                    transaction.id = childSnapshot.key;
                    cashTransactions.push(transaction);
                });
                displayCashTransactions();
                updateCashBalance();
                updateDashboardStats();
            });

            // تحميل الرصيد الابتدائي
            database.ref('initialCashBalance').on('value', (snapshot) => {
                initialCashBalance = snapshot.val() || 0;
                updateCashBalance();
            });
        }

        // حفظ البيانات إلى Firebase
        function saveToFirebase(path, data, id = null) {
            if (id) {
                return database.ref(`${path}/${id}`).set(data);
            } else {
                return database.ref(path).push(data);
            }
        }

        // حذف البيانات من Firebase
        function deleteFromFirebase(path, id) {
            return database.ref(`${path}/${id}`).remove();
        }

        // إعداد الشريط الجانبي
        function setupSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const closeSidebar = document.getElementById('closeSidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
            
            // فتح الشريط الجانبي
            mobileMenuToggle.addEventListener('click', function() {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            
            // إغلاق الشريط الجانبي
            function closeSidebarFunc() {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }
            
            closeSidebar.addEventListener('click', closeSidebarFunc);
            sidebarOverlay.addEventListener('click', closeSidebarFunc);
            
            // إغلاق الشريط الجانبي عند النقر على رابط
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // إزالة النشاط من جميع الروابط
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    
                    // إضافة النشاط للرابط الحالي
                    this.classList.add('active');
                    
                    // إخفاء جميع المحتويات
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // عرض المحتوى المحدد
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // إذا كانت الصفحة الرئيسية، نقوم بتحديثها
                    if (tabId === 'dashboard') {
                        updateDashboard();
                    }
                    
                    // إغلاق الشريط الجانبي على الهواتف المحمولة
                    if (window.innerWidth <= 768) {
                        closeSidebarFunc();
                    }
                });
            });
            
            // إغلاق الشريط الجانبي عند الضغط على زر Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeSidebarFunc();
                }
            });
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // نموذج إضافة موظف
            document.getElementById('employeeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEmployee();
            });
            
            // إلغاء التعديل للموظفين
            document.getElementById('cancelEditEmployee').addEventListener('click', function() {
                resetEmployeeForm();
            });
            
            // نموذج تسجيل الحضور
            document.getElementById('attendanceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveAttendance();
            });
            
            // إلغاء التعديل للحضور
            document.getElementById('cancelEditAttendance').addEventListener('click', function() {
                resetAttendanceForm();
            });
            
            // نموذج الإجازات
            document.getElementById('vacationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveVacation();
            });
            
            // إلغاء التعديل للإجازات
            document.getElementById('cancelEditVacation').addEventListener('click', function() {
                resetVacationForm();
            });
            
            // نموذج السلف
            document.getElementById('advanceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveAdvance();
            });
            
            // إلغاء التعديل للسلف
            document.getElementById('cancelEditAdvance').addEventListener('click', function() {
                resetAdvanceForm();
            });
            
            // نموذج المكافآت
            document.getElementById('bonusForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveBonus();
            });
            
            // إلغاء التعديل للمكافآت
            document.getElementById('cancelEditBonus').addEventListener('click', function() {
                resetBonusForm();
            });
            
            // نموذج الخصومات
            document.getElementById('deductionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveDeduction();
            });
            
            // إلغاء التعديل للخصومات
            document.getElementById('cancelEditDeduction').addEventListener('click', function() {
                resetDeductionForm();
            });
            
            // نموذج المصروفات
            document.getElementById('expensesForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveExpense();
            });
            
            // إلغاء التعديل للمصروفات
            document.getElementById('cancelEditExpense').addEventListener('click', function() {
                resetExpenseForm();
            });
            
            // نموذج حركات الخزينة
            document.getElementById('cashTransactionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCashTransaction();
            });
            
            // إلغاء التعديل لحركات الخزينة
            document.getElementById('cancelEditCash').addEventListener('click', function() {
                resetCashTransactionForm();
            });
        }

        // تحديث جميع القوائم تلقائياً
        function updateAllLists() {
            displayEmployees();
            displayAttendance();
            displayVacations();
            displayAdvances();
            displayBonuses();
            displayDeductions();
            displayExpenses();
            displayCashTransactions();
        }

        // تحديث قوائم الموظفين في النماذج
        function updateEmployeeSelects() {
            const employeeSelects = [
                'employeeSelect', 'vacationEmployee', 'advanceEmployee', 'bonusEmployee', 'deductionEmployee', 'dashboardEmployee'
            ];
            
            employeeSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">اختر الموظف</option>';
                    
                    employees.forEach(employee => {
                        const option = document.createElement('option');
                        option.value = employee.id;
                        option.textContent = employee.name;
                        select.appendChild(option);
                    });
                }
            });
        }

        // دوال الصفحة الرئيسية
        function updateDashboard() {
            updateDashboardStats();
            updateRecentActivity();
            updateDashboardFilters();
        }

        function updateDashboardStats() {
            // تحديث إحصائيات الموظفين
            document.getElementById('totalEmployees').textContent = employees.length;
            
            // تحديث إحصائيات الحضور
            document.getElementById('totalAttendance').textContent = attendance.length;
            
            // تحديث إحصائيات الإجازات
            document.getElementById('totalVacations').textContent = vacations.length;
            
            // تحديث إحصائيات السلف
            const totalAdvancesAmount = advances.reduce((sum, advance) => sum + advance.amount, 0);
            document.getElementById('totalAdvances').textContent = totalAdvancesAmount.toFixed(2);
            
            // تحديث إحصائيات المكافآت
            const totalBonusesAmount = bonuses.reduce((sum, bonus) => sum + bonus.amount, 0);
            document.getElementById('totalBonuses').textContent = totalBonusesAmount.toFixed(2);
            
            // تحديث إحصائيات الخصومات
            const totalDeductionsAmount = deductions.reduce((sum, deduction) => sum + deduction.amount, 0);
            document.getElementById('totalDeductions').textContent = totalDeductionsAmount.toFixed(2);
            
            // تحديث إحصائيات المصروفات
            const totalExpensesAmount = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('totalExpenses').textContent = totalExpensesAmount.toFixed(2);
            
            // تحديث رصيد الخزينة
            const cashBalance = calculateCashBalance();
            document.getElementById('cashBalance').textContent = cashBalance.toFixed(2);
            document.getElementById('cashBalanceAmount').textContent = cashBalance.toFixed(2);
        }

        function updateRecentActivity() {
            const recentActivity = document.getElementById('recentActivity');
            recentActivity.innerHTML = '';
            
            // جمع جميع الأنشطة في مصفوفة واحدة
            let allActivities = [];
            
            // إضافة سجلات الحضور
            attendance.forEach(record => {
                allActivities.push({
                    type: 'attendance',
                    title: `تسجيل ${record.status} للموظف ${record.employeeName}`,
                    date: record.date,
                    icon: 'fas fa-calendar-check'
                });
            });
            
            // إضافة الإجازات
            vacations.forEach(vacation => {
                allActivities.push({
                    type: 'vacation',
                    title: `تسجيل إجازة للموظف ${vacation.employeeName}`,
                    date: vacation.startDate,
                    icon: 'fas fa-umbrella-beach'
                });
            });
            
            // إضافة السلف
            advances.forEach(advance => {
                allActivities.push({
                    type: 'advance',
                    title: `تسجيل سلفة للموظف ${advance.employeeName}`,
                    date: advance.date,
                    icon: 'fas fa-hand-holding-usd'
                });
            });
            
            // إضافة المكافآت
            bonuses.forEach(bonus => {
                allActivities.push({
                    type: 'bonus',
                    title: `تسجيل مكافأة للموظف ${bonus.employeeName}`,
                    date: bonus.date,
                    icon: 'fas fa-gift'
                });
            });
            
            // إضافة الخصومات
            deductions.forEach(deduction => {
                allActivities.push({
                    type: 'deduction',
                    title: `تسجيل خصم للموظف ${deduction.employeeName}`,
                    date: deduction.date,
                    icon: 'fas fa-minus-circle'
                });
            });
            
            // إضافة المصروفات
            expenses.forEach(expense => {
                allActivities.push({
                    type: 'expense',
                    title: `تسجيل مصروف: ${expense.description}`,
                    date: expense.date,
                    icon: 'fas fa-receipt'
                });
            });
            
            // إضافة حركات الخزينة
            cashTransactions.forEach(transaction => {
                allActivities.push({
                    type: 'cash',
                    title: `حركة خزينة: ${transaction.description}`,
                    date: transaction.date,
                    icon: 'fas fa-piggy-bank'
                });
            });
            
            // ترتيب الأنشطة من الأحدث إلى الأقدم
            allActivities.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // عرض آخر 10 أنشطة فقط
            const recentItems = allActivities.slice(0, 10);
            
            if (recentItems.length === 0) {
                recentActivity.innerHTML = '<p>لا توجد نشاطات مسجلة بعد</p>';
                return;
            }
            
            recentItems.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `
                    <div class="activity-icon">
                        <i class="${activity.icon}"></i>
                    </div>
                    <div class="activity-details">
                        <div class="activity-title">${activity.title}</div>
                        <div class="activity-date">${formatDate(activity.date)}</div>
                    </div>
                `;
                recentActivity.appendChild(activityItem);
            });
        }

        function updateDashboardFilters() {
            // تحديث قائمة الموظفين في الفلاتر
            updateEmployeeSelects();
            
            // تعيين التواريخ الافتراضية (آخر 30 يوم)
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            document.getElementById('dashboardDateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('dashboardDateTo').value = today.toISOString().split('T')[0];
        }

        function applyDashboardFilters() {
            // تطبيق الفلاتر على البيانات
            const dateFrom = document.getElementById('dashboardDateFrom').value;
            const dateTo = document.getElementById('dashboardDateTo').value;
            const employeeId = document.getElementById('dashboardEmployee').value;
            
            // في تطبيق حقيقي، سنقوم بتصفية البيانات حسب الفلاتر
            // لكن في هذا المثال، سنعرض رسالة توضيحية
            let filterMessage = 'تم تطبيق الفلاتر: ';
            
            if (dateFrom) {
                filterMessage += `من ${formatDate(dateFrom)} `;
            }
            
            if (dateTo) {
                filterMessage += `إلى ${formatDate(dateTo)} `;
            }
            
            if (employeeId) {
                const employee = employees.find(e => e.id === employeeId);
                if (employee) {
                    filterMessage += `للموظف ${employee.name}`;
                }
            }
            
            showAlert(filterMessage, 'success');
            
            // تحديث الإحصائيات حسب الفلاتر
            updateFilteredStats(dateFrom, dateTo, employeeId);
            
            // تحديث إحصائيات الحضور للموظف المحدد
            updateEmployeeAttendanceStats(dateFrom, dateTo, employeeId);
        }

        function updateFilteredStats(dateFrom, dateTo, employeeId) {
            // تصفية البيانات حسب الفلاتر
            let filteredAttendance = attendance;
            let filteredVacations = vacations;
            let filteredAdvances = advances;
            let filteredBonuses = bonuses;
            let filteredDeductions = deductions;
            let filteredExpenses = expenses;
            
            if (dateFrom) {
                filteredAttendance = filteredAttendance.filter(a => a.date >= dateFrom);
                filteredVacations = filteredVacations.filter(v => v.startDate >= dateFrom);
                filteredAdvances = filteredAdvances.filter(a => a.date >= dateFrom);
                filteredBonuses = filteredBonuses.filter(b => b.date >= dateFrom);
                filteredDeductions = filteredDeductions.filter(d => d.date >= dateFrom);
                filteredExpenses = filteredExpenses.filter(e => e.date >= dateFrom);
            }
            
            if (dateTo) {
                filteredAttendance = filteredAttendance.filter(a => a.date <= dateTo);
                filteredVacations = filteredVacations.filter(v => v.startDate <= dateTo);
                filteredAdvances = filteredAdvances.filter(a => a.date <= dateTo);
                filteredBonuses = filteredBonuses.filter(b => b.date <= dateTo);
                filteredDeductions = filteredDeductions.filter(d => d.date <= dateTo);
                filteredExpenses = filteredExpenses.filter(e => e.date <= dateTo);
            }
            
            if (employeeId) {
                filteredAttendance = filteredAttendance.filter(a => a.employeeId === employeeId);
                filteredVacations = filteredVacations.filter(v => v.employeeId === employeeId);
                filteredAdvances = filteredAdvances.filter(a => a.employeeId === employeeId);
                filteredBonuses = filteredBonuses.filter(b => b.employeeId === employeeId);
                filteredDeductions = filteredDeductions.filter(d => d.employeeId === employeeId);
            }
            
            // تحديث الإحصائيات مع البيانات المصفاة
            document.getElementById('totalAttendance').textContent = filteredAttendance.length;
            document.getElementById('totalVacations').textContent = filteredVacations.length;
            
            const totalAdvancesAmount = filteredAdvances.reduce((sum, advance) => sum + advance.amount, 0);
            document.getElementById('totalAdvances').textContent = totalAdvancesAmount.toFixed(2);
            
            const totalBonusesAmount = filteredBonuses.reduce((sum, bonus) => sum + bonus.amount, 0);
            document.getElementById('totalBonuses').textContent = totalBonusesAmount.toFixed(2);
            
            const totalDeductionsAmount = filteredDeductions.reduce((sum, deduction) => sum + deduction.amount, 0);
            document.getElementById('totalDeductions').textContent = totalDeductionsAmount.toFixed(2);
            
            const totalExpensesAmount = filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('totalExpenses').textContent = totalExpensesAmount.toFixed(2);
        }

        function resetDashboardFilters() {
            document.getElementById('dashboardDateFrom').value = '';
            document.getElementById('dashboardDateTo').value = '';
            document.getElementById('dashboardEmployee').value = '';
            
            // إعادة تعيين الإحصائيات إلى القيم الأصلية
            updateDashboardStats();
            
            // إخفاء إحصائيات الحضور للموظف المحدد
            document.getElementById('employeeAttendanceStats').style.display = 'none';
            
            showAlert('تم إعادة تعيين الفلاتر', 'success');
        }

        function exportDashboardToExcel() {
            // إنشاء مصفوفة للبيانات
            const dashboardData = [
                ['إحصائيات النظام', '', ''],
                ['', '', ''],
                ['نوع الإحصائية', 'القيمة', 'التفاصيل'],
                ['إجمالي الموظفين', employees.length, 'موظف'],
                ['إجمالي سجلات الحضور', attendance.length, 'سجل'],
                ['إجمالي الإجازات', vacations.length, 'إجازة'],
                ['إجمالي السلف', advances.reduce((sum, a) => sum + a.amount, 0).toFixed(2), 'ريال'],
                ['إجمالي المكافآت', bonuses.reduce((sum, b) => sum + b.amount, 0).toFixed(2), 'ريال'],
                ['إجمالي الخصومات', deductions.reduce((sum, d) => sum + d.amount, 0).toFixed(2), 'ريال'],
                ['إجمالي المصروفات', expenses.reduce((sum, e) => sum + e.amount, 0).toFixed(2), 'ريال'],
                ['رصيد الخزينة الحالي', calculateCashBalance().toFixed(2), 'ريال'],
                ['', '', ''],
                ['تاريخ التصدير', new Date().toLocaleDateString('ar-EG'), '']
            ];
            
            // إنشاء ورقة العمل
            const ws = XLSX.utils.aoa_to_sheet(dashboardData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "إحصائيات النظام");
            
            // حفظ الملف
            XLSX.writeFile(wb, "إحصائيات_النظام.xlsx");
            
            showAlert('تم تصدير إحصائيات النظام إلى Excel بنجاح', 'success');
        }

        // إحصائيات الحضور للموظف المحدد
        function updateEmployeeAttendanceStats(dateFrom, dateTo, employeeId) {
            const employeeAttendanceStats = document.getElementById('employeeAttendanceStats');
            const employeeAttendanceDetails = document.getElementById('employeeAttendanceDetails');
            
            if (!employeeId) {
                employeeAttendanceStats.style.display = 'none';
                return;
            }
            
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                employeeAttendanceStats.style.display = 'none';
                return;
            }
            
            // تصفية سجلات الحضور للموظف المحدد
            let filteredAttendance = attendance.filter(a => a.employeeId === employeeId);
            
            if (dateFrom) {
                filteredAttendance = filteredAttendance.filter(a => a.date >= dateFrom);
            }
            
            if (dateTo) {
                filteredAttendance = filteredAttendance.filter(a => a.date <= dateTo);
            }
            
            // حساب إحصائيات الحضور
            const presenceDays = filteredAttendance.filter(a => a.status === 'حضور').length;
            const absenceDays = filteredAttendance.filter(a => a.status === 'غياب').length;
            const vacationDays = filteredAttendance.filter(a => a.status === 'إجازة').length;
            
            // عرض الإحصائيات
            employeeAttendanceDetails.innerHTML = `
                <div class="stat-card">
                    <div>اسم الموظف</div>
                    <div class="stat-value">${employee.name}</div>
                </div>
                <div class="stat-card">
                    <div>أيام الحضور</div>
                    <div class="stat-value attendance-days">${presenceDays}</div>
                </div>
                <div class="stat-card">
                    <div>أيام الغياب</div>
                    <div class="stat-value absence">${absenceDays}</div>
                </div>
                <div class="stat-card">
                    <div>أيام الإجازة</div>
                    <div class="stat-value vacation">${vacationDays}</div>
                </div>
            `;
            
            employeeAttendanceStats.style.display = 'block';
        }

        // إرسال التقارير عبر واتساب
        function sendReportsToAllEmployees() {
            const month = document.getElementById('reportMonthSend').value;
            if (!month) {
                showAlert('الرجاء اختيار شهر', 'danger');
                return;
            }
            
            if (employees.length === 0) {
                showAlert('لا توجد موظفين مسجلين في النظام', 'danger');
                return;
            }
            
            let sentCount = 0;
            let errorCount = 0;
            
            employees.forEach(employee => {
                if (employee.phone) {
                    try {
                        sendEmployeeReport(employee.id, month);
                        sentCount++;
                    } catch (error) {
                        console.error(`خطأ في إرسال التقرير للموظف ${employee.name}:`, error);
                        errorCount++;
                    }
                } else {
                    errorCount++;
                }
            });
            
            showAlert(`تم إرسال ${sentCount} تقرير بنجاح، ${errorCount} فشل في الإرسال`, 
                     errorCount === 0 ? 'success' : 'warning');
        }

        function sendReportToSelectedEmployee() {
            const month = document.getElementById('reportMonthSend').value;
            const employeeId = document.getElementById('dashboardEmployee').value;
            
            if (!month) {
                showAlert('الرجاء اختيار شهر', 'danger');
                return;
            }
            
            if (!employeeId) {
                showAlert('الرجاء اختيار موظف من القائمة', 'danger');
                return;
            }
            
            sendEmployeeReport(employeeId, month);
        }

        function sendEmployeeReport(employeeId, month) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showAlert('الموظف غير موجود', 'danger');
                return;
            }
            
            if (!employee.phone) {
                showAlert(`لا يوجد رقم هاتف مسجل للموظف ${employee.name}`, 'danger');
                return;
            }
            
            // إنشاء التقرير
            const reportData = generateEmployeeReportData(employeeId, month);
            
            // إنشاء نص الرسالة
            const message = `تقرير ${month} للموظف ${employee.name}\n\n` +
                           `إجمالي أيام الحضور: ${reportData.presenceDays}\n` +
                           `إجمالي أيام الغياب: ${reportData.absenceDays}\n` +
                           `إجمالي أيام الإجازة: ${reportData.vacationDays}\n` +
                           `الراتب الأساسي: ${reportData.baseSalary.toFixed(2)}\n` +
                           `إجمالي السلف: ${reportData.totalAdvances.toFixed(2)}\n` +
                           `إجمالي المكافآت: ${reportData.totalBonuses.toFixed(2)}\n` +
                           `إجمالي الخصومات: ${reportData.totalDeductions.toFixed(2)}\n` +
                           `صافي الراتب: ${reportData.netSalary.toFixed(2)}\n\n` +
                           `تم إرسال هذا التقرير تلقائياً من نظام إدارة الحضور والرواتب`;
            
            // ترميز الرسالة للرابط
            const encodedMessage = encodeURIComponent(message);
            
            // إنشاء رابط واتساب
            const whatsappUrl = `https://wa.me/${employee.phone}?text=${encodedMessage}`;
            
            // فتح نافذة جديدة لواتساب
            window.open(whatsappUrl, '_blank');
            
            showAlert(`تم إنشاء تقرير ${employee.name} وإرساله عبر واتساب`, 'success');
        }

        function generateEmployeeReportData(employeeId, month) {
            const employee = employees.find(e => e.id === employeeId);
            
            // تصفية البيانات حسب الشهر والموظف
            const monthAttendance = attendance.filter(a => a.date.startsWith(month) && a.employeeId === employeeId);
            const monthAdvances = advances.filter(a => a.date.startsWith(month) && a.employeeId === employeeId);
            const monthBonuses = bonuses.filter(b => b.date.startsWith(month) && b.employeeId === employeeId);
            const monthDeductions = deductions.filter(d => d.date.startsWith(month) && d.employeeId === employeeId);
            
            // حساب إحصائيات الحضور
            const presenceDays = monthAttendance.filter(a => a.status === 'حضور').length;
            const absenceDays = monthAttendance.filter(a => a.status === 'غياب').length;
            const vacationDays = monthAttendance.filter(a => a.status === 'إجازة').length;
            
            // حساب الراتب
            const dailyRate = employee.salary / 30;
            const baseSalary = dailyRate * presenceDays;
            
            // حساب السلف والمكافآت والخصومات
            const totalAdvances = monthAdvances.reduce((sum, advance) => sum + advance.amount, 0);
            const totalBonuses = monthBonuses.reduce((sum, bonus) => sum + bonus.amount, 0);
            const totalDeductions = monthDeductions.reduce((sum, deduction) => sum + deduction.amount, 0);
            
            // حساب صافي الراتب
            const netSalary = baseSalary + totalBonuses - totalAdvances - totalDeductions;
            
            return {
                presenceDays,
                absenceDays,
                vacationDays,
                baseSalary,
                totalAdvances,
                totalBonuses,
                totalDeductions,
                netSalary
            };
        }

        function showTab(tabId) {
            // إخفاء جميع المحتويات
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // إزالة النشاط من جميع الروابط
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            
            // عرض المحتوى المحدد
            document.getElementById(tabId).classList.add('active');
            
            // تفعيل الرابط في الشريط الجانبي
            const activeLink = document.querySelector(`.sidebar-menu a[data-tab="${tabId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // إذا كانت الصفحة الرئيسية، نقوم بتحديثها
            if (tabId === 'dashboard') {
                updateDashboard();
            }
        }

        // إدارة الموظفين
        function saveEmployee() {
            const name = document.getElementById('employeeName').value;
            const phone = document.getElementById('employeePhone').value;
            const position = document.getElementById('employeePosition').value;
            const salary = parseFloat(document.getElementById('employeeSalary').value);
            const workingDays = parseInt(document.getElementById('workingDays').value);
            const vacationDays = parseInt(document.getElementById('vacationDays').value);
            
            const employeeData = {
                name,
                phone,
                position,
                salary,
                workingDays,
                vacationDays
            };
            
            showLoading('جاري حفظ بيانات الموظف...');
            
            if (editingEmployeeId) {
                // تعديل موظف موجود
                saveToFirebase('employees', employeeData, editingEmployeeId)
                    .then(() => {
                        showAlert('تم تعديل بيانات الموظف بنجاح', 'success');
                        resetEmployeeForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تعديل بيانات الموظف', 'danger');
                        console.error('Error updating employee:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            } else {
                // إضافة موظف جديد
                saveToFirebase('employees', employeeData)
                    .then(() => {
                        showAlert('تم حفظ بيانات الموظف بنجاح', 'success');
                        resetEmployeeForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء حفظ بيانات الموظف', 'danger');
                        console.error('Error saving employee:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function displayEmployees() {
            const tbody = document.getElementById('employeesList');
            tbody.innerHTML = '';
            
            employees.forEach(employee => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${employee.name}</td>
                    <td>${employee.phone}</td>
                    <td>${employee.position}</td>
                    <td>${employee.salary}</td>
                    <td>${employee.workingDays}</td>
                    <td>${employee.vacationDays}</td>
                    <td class="no-print">
                        <button onclick="editEmployee('${employee.id}')">تعديل</button>
                        <button class="btn-danger" onclick="deleteEmployee('${employee.id}')">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editEmployee(id) {
            const employee = employees.find(e => e.id === id);
            if (employee) {
                document.getElementById('employeeName').value = employee.name;
                document.getElementById('employeePhone').value = employee.phone;
                document.getElementById('employeePosition').value = employee.position;
                document.getElementById('employeeSalary').value = employee.salary;
                document.getElementById('workingDays').value = employee.workingDays;
                document.getElementById('vacationDays').value = employee.vacationDays;
                
                editingEmployeeId = id;
                document.getElementById('cancelEditEmployee').style.display = 'inline-block';
                
                // التمرير إلى أعلى النموذج
                document.getElementById('employeeForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteEmployee(id) {
            if (confirm('هل أنت متأكد من حذف هذا الموظف؟')) {
                showLoading('جاري حذف الموظف...');
                
                deleteFromFirebase('employees', id)
                    .then(() => {
                        showAlert('تم حذف الموظف بنجاح', 'success');
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء حذف الموظف', 'danger');
                        console.error('Error deleting employee:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function resetEmployeeForm() {
            document.getElementById('employeeForm').reset();
            document.getElementById('workingDays').value = 26;
            document.getElementById('vacationDays').value = 4;
            editingEmployeeId = null;
            document.getElementById('cancelEditEmployee').style.display = 'none';
        }

        // تسجيل الحضور
        function saveAttendance() {
            const date = document.getElementById('attendanceDate').value;
            const employeeId = document.getElementById('employeeSelect').value;
            const status = document.getElementById('attendanceStatus').value;
            const notes = document.getElementById('notes').value;
            
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showAlert('الرجاء اختيار موظف صحيح', 'danger');
                return;
            }
            
            const attendanceData = {
                date,
                employeeId,
                employeeName: employee.name,
                status,
                notes
            };
            
            showLoading('جاري حفظ بيانات الحضور...');
            
            if (editingAttendanceId) {
                // تعديل سجل موجود
                saveToFirebase('attendance', attendanceData, editingAttendanceId)
                    .then(() => {
                        showAlert('تم تعديل السجل بنجاح', 'success');
                        resetAttendanceForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تعديل السجل', 'danger');
                        console.error('Error updating attendance:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            } else {
                // التحقق من عدم وجود تسجيل مسبق لنفس الموظف في نفس التاريخ
                const existingRecord = attendance.find(a => 
                    a.employeeId === employeeId && a.date === date
                );
                
                if (existingRecord) {
                    showAlert('تم تسجيل حالة هذا الموظف مسبقاً في هذا التاريخ', 'danger');
                    hideLoading();
                    return;
                }
                
                // إضافة سجل جديد
                saveToFirebase('attendance', attendanceData)
                    .then(() => {
                        showAlert('تم تسجيل الحضور بنجاح', 'success');
                        resetAttendanceForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تسجيل الحضور', 'danger');
                        console.error('Error saving attendance:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function displayAttendance() {
            const tbody = document.getElementById('attendanceList');
            tbody.innerHTML = '';
            
            // ترتيب السجل من الأحدث إلى الأقدم
            const sortedAttendance = [...attendance].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedAttendance.forEach(record => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(record.date)}</td>
                    <td>${record.employeeName}</td>
                    <td>${record.status}</td>
                    <td>${record.notes || ''}</td>
                    <td class="no-print">
                        <button onclick="editAttendance('${record.id}')">تعديل</button>
                        <button class="btn-danger" onclick="deleteAttendance('${record.id}')">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editAttendance(id) {
            const record = attendance.find(a => a.id === id);
            if (record) {
                document.getElementById('attendanceDate').value = record.date;
                document.getElementById('employeeSelect').value = record.employeeId;
                document.getElementById('attendanceStatus').value = record.status;
                document.getElementById('notes').value = record.notes || '';
                
                editingAttendanceId = id;
                document.getElementById('cancelEditAttendance').style.display = 'inline-block';
                
                // التمرير إلى أعلى النموذج
                document.getElementById('attendanceForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteAttendance(id) {
            if (confirm('هل أنت متأكد من حذف هذا السجل؟')) {
                showLoading('جاري حذف السجل...');
                
                deleteFromFirebase('attendance', id)
                    .then(() => {
                        showAlert('تم حذف السجل بنجاح', 'success');
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء حذف السجل', 'danger');
                        console.error('Error deleting attendance:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function resetAttendanceForm() {
            document.getElementById('attendanceForm').reset();
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            editingAttendanceId = null;
            document.getElementById('cancelEditAttendance').style.display = 'none';
        }

        // الإجازات
        function saveVacation() {
            const employeeId = document.getElementById('vacationEmployee').value;
            const startDate = document.getElementById('vacationStart').value;
            const endDate = document.getElementById('vacationEnd').value;
            const type = document.getElementById('vacationType').value;
            const notes = document.getElementById('vacationNotes').value;
            
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showAlert('الرجاء اختيار موظف صحيح', 'danger');
                return;
            }
            
            const vacationData = {
                employeeId,
                employeeName: employee.name,
                startDate,
                endDate,
                type,
                notes
            };
            
            showLoading('جاري حفظ بيانات الإجازة...');
            
            if (editingVacationId) {
                // تعديل إجازة موجودة
                saveToFirebase('vacations', vacationData, editingVacationId)
                    .then(() => {
                        showAlert('تم تعديل الإجازة بنجاح', 'success');
                        resetVacationForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تعديل الإجازة', 'danger');
                        console.error('Error updating vacation:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            } else {
                // إضافة إجازة جديدة
                saveToFirebase('vacations', vacationData)
                    .then(() => {
                        showAlert('تم تسجيل الإجازة بنجاح', 'success');
                        resetVacationForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تسجيل الإجازة', 'danger');
                        console.error('Error saving vacation:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function displayVacations() {
            const tbody = document.getElementById('vacationList');
            tbody.innerHTML = '';
            
            // ترتيب السجل من الأحدث إلى الأقدم
            const sortedVacations = [...vacations].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
            
            sortedVacations.forEach(vacation => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${vacation.employeeName}</td>
                    <td>${formatDate(vacation.startDate)}</td>
                    <td>${formatDate(vacation.endDate)}</td>
                    <td>${vacation.type}</td>
                    <td>${vacation.notes || ''}</td>
                    <td class="no-print">
                        <button onclick="editVacation('${vacation.id}')">تعديل</button>
                        <button class="btn-danger" onclick="deleteVacation('${vacation.id}')">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editVacation(id) {
            const vacation = vacations.find(v => v.id === id);
            if (vacation) {
                document.getElementById('vacationEmployee').value = vacation.employeeId;
                document.getElementById('vacationStart').value = vacation.startDate;
                document.getElementById('vacationEnd').value = vacation.endDate;
                document.getElementById('vacationType').value = vacation.type;
                document.getElementById('vacationNotes').value = vacation.notes || '';
                
                editingVacationId = id;
                document.getElementById('cancelEditVacation').style.display = 'inline-block';
                
                // التمرير إلى أعلى النموذج
                document.getElementById('vacationForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteVacation(id) {
            if (confirm('هل أنت متأكد من حذف هذه الإجازة؟')) {
                showLoading('جاري حذف الإجازة...');
                
                deleteFromFirebase('vacations', id)
                    .then(() => {
                        showAlert('تم حذف الإجازة بنجاح', 'success');
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء حذف الإجازة', 'danger');
                        console.error('Error deleting vacation:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function resetVacationForm() {
            document.getElementById('vacationForm').reset();
            document.getElementById('vacationStart').value = new Date().toISOString().split('T')[0];
            document.getElementById('vacationEnd').value = new Date().toISOString().split('T')[0];
            editingVacationId = null;
            document.getElementById('cancelEditVacation').style.display = 'none';
        }

        // السلف
        function saveAdvance() {
            const employeeId = document.getElementById('advanceEmployee').value;
            const date = document.getElementById('advanceDate').value;
            const amount = parseFloat(document.getElementById('advanceAmount').value);
            const reason = document.getElementById('advanceReason').value;
            
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showAlert('الرجاء اختيار موظف صحيح', 'danger');
                return;
            }
            
            const advanceData = {
                employeeId,
                employeeName: employee.name,
                date,
                amount,
                reason
            };
            
            showLoading('جاري حفظ بيانات السلفة...');
            
            if (editingAdvanceId) {
                // تعديل سلفة موجودة
                saveToFirebase('advances', advanceData, editingAdvanceId)
                    .then(() => {
                        showAlert('تم تعديل السلفة بنجاح', 'success');
                        resetAdvanceForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تعديل السلفة', 'danger');
                        console.error('Error updating advance:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            } else {
                // إضافة سلفة جديدة
                saveToFirebase('advances', advanceData)
                    .then(() => {
                        showAlert('تم تسجيل السلفة بنجاح', 'success');
                        resetAdvanceForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تسجيل السلفة', 'danger');
                        console.error('Error saving advance:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function displayAdvances() {
            const tbody = document.getElementById('advanceList');
            tbody.innerHTML = '';
            
            // ترتيب السجل من الأحدث إلى الأقدم
            const sortedAdvances = [...advances].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedAdvances.forEach(advance => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(advance.date)}</td>
                    <td>${advance.employeeName}</td>
                    <td>${advance.amount}</td>
                    <td>${advance.reason || ''}</td>
                    <td class="no-print">
                        <button onclick="editAdvance('${advance.id}')">تعديل</button>
                        <button class="btn-danger" onclick="deleteAdvance('${advance.id}')">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editAdvance(id) {
            const advance = advances.find(a => a.id === id);
            if (advance) {
                document.getElementById('advanceEmployee').value = advance.employeeId;
                document.getElementById('advanceDate').value = advance.date;
                document.getElementById('advanceAmount').value = advance.amount;
                document.getElementById('advanceReason').value = advance.reason || '';
                
                editingAdvanceId = id;
                document.getElementById('cancelEditAdvance').style.display = 'inline-block';
                
                // التمرير إلى أعلى النموذج
                document.getElementById('advanceForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteAdvance(id) {
            if (confirm('هل أنت متأكد من حذف هذه السلفة؟')) {
                showLoading('جاري حذف السلفة...');
                
                deleteFromFirebase('advances', id)
                    .then(() => {
                        showAlert('تم حذف السلفة بنجاح', 'success');
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء حذف السلفة', 'danger');
                        console.error('Error deleting advance:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function resetAdvanceForm() {
            document.getElementById('advanceForm').reset();
            document.getElementById('advanceDate').value = new Date().toISOString().split('T')[0];
            editingAdvanceId = null;
            document.getElementById('cancelEditAdvance').style.display = 'none';
        }

        // المكافآت
        function saveBonus() {
            const employeeId = document.getElementById('bonusEmployee').value;
            const date = document.getElementById('bonusDate').value;
            const amount = parseFloat(document.getElementById('bonusAmount').value);
            const reason = document.getElementById('bonusReason').value;
            
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showAlert('الرجاء اختيار موظف صحيح', 'danger');
                return;
            }
            
            const bonusData = {
                employeeId,
                employeeName: employee.name,
                date,
                amount,
                reason
            };
            
            showLoading('جاري حفظ بيانات المكافأة...');
            
            if (editingBonusId) {
                // تعديل مكافأة موجودة
                saveToFirebase('bonuses', bonusData, editingBonusId)
                    .then(() => {
                        showAlert('تم تعديل المكافأة بنجاح', 'success');
                        resetBonusForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تعديل المكافأة', 'danger');
                        console.error('Error updating bonus:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            } else {
                // إضافة مكافأة جديدة
                saveToFirebase('bonuses', bonusData)
                    .then(() => {
                        showAlert('تم تسجيل المكافأة بنجاح', 'success');
                        resetBonusForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تسجيل المكافأة', 'danger');
                        console.error('Error saving bonus:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function displayBonuses() {
            const tbody = document.getElementById('bonusList');
            tbody.innerHTML = '';
            
            // ترتيب السجل من الأحدث إلى الأقدم
            const sortedBonuses = [...bonuses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedBonuses.forEach(bonus => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(bonus.date)}</td>
                    <td>${bonus.employeeName}</td>
                    <td>${bonus.amount}</td>
                    <td>${bonus.reason || ''}</td>
                    <td class="no-print">
                        <button onclick="editBonus('${bonus.id}')">تعديل</button>
                        <button class="btn-danger" onclick="deleteBonus('${bonus.id}')">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editBonus(id) {
            const bonus = bonuses.find(b => b.id === id);
            if (bonus) {
                document.getElementById('bonusEmployee').value = bonus.employeeId;
                document.getElementById('bonusDate').value = bonus.date;
                document.getElementById('bonusAmount').value = bonus.amount;
                document.getElementById('bonusReason').value = bonus.reason || '';
                
                editingBonusId = id;
                document.getElementById('cancelEditBonus').style.display = 'inline-block';
                
                // التمرير إلى أعلى النموذج
                document.getElementById('bonusForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteBonus(id) {
            if (confirm('هل أنت متأكد من حذف هذه المكافأة؟')) {
                showLoading('جاري حذف المكافأة...');
                
                deleteFromFirebase('bonuses', id)
                    .then(() => {
                        showAlert('تم حذف المكافأة بنجاح', 'success');
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء حذف المكافأة', 'danger');
                        console.error('Error deleting bonus:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function resetBonusForm() {
            document.getElementById('bonusForm').reset();
            document.getElementById('bonusDate').value = new Date().toISOString().split('T')[0];
            editingBonusId = null;
            document.getElementById('cancelEditBonus').style.display = 'none';
        }

        // الخصومات
        function saveDeduction() {
            const employeeId = document.getElementById('deductionEmployee').value;
            const date = document.getElementById('deductionDate').value;
            const amount = parseFloat(document.getElementById('deductionAmount').value);
            const reason = document.getElementById('deductionReason').value;
            const notes = document.getElementById('deductionNotes').value;
            
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showAlert('الرجاء اختيار موظف صحيح', 'danger');
                return;
            }
            
            const deductionData = {
                employeeId,
                employeeName: employee.name,
                date,
                amount,
                reason,
                notes
            };
            
            showLoading('جاري حفظ بيانات الخصم...');
            
            if (editingDeductionId) {
                // تعديل خصم موجود
                saveToFirebase('deductions', deductionData, editingDeductionId)
                    .then(() => {
                        showAlert('تم تعديل الخصم بنجاح', 'success');
                        resetDeductionForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تعديل الخصم', 'danger');
                        console.error('Error updating deduction:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            } else {
                // إضافة خصم جديد
                saveToFirebase('deductions', deductionData)
                    .then(() => {
                        showAlert('تم تسجيل الخصم بنجاح', 'success');
                        resetDeductionForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تسجيل الخصم', 'danger');
                        console.error('Error saving deduction:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function displayDeductions() {
            const tbody = document.getElementById('deductionList');
            tbody.innerHTML = '';
            
            // ترتيب السجل من الأحدث إلى الأقدم
            const sortedDeductions = [...deductions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedDeductions.forEach(deduction => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(deduction.date)}</td>
                    <td>${deduction.employeeName}</td>
                    <td>${deduction.amount}</td>
                    <td>${deduction.reason}</td>
                    <td>${deduction.notes || ''}</td>
                    <td class="no-print">
                        <button onclick="editDeduction('${deduction.id}')">تعديل</button>
                        <button class="btn-danger" onclick="deleteDeduction('${deduction.id}')">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editDeduction(id) {
            const deduction = deductions.find(d => d.id === id);
            if (deduction) {
                document.getElementById('deductionEmployee').value = deduction.employeeId;
                document.getElementById('deductionDate').value = deduction.date;
                document.getElementById('deductionAmount').value = deduction.amount;
                document.getElementById('deductionReason').value = deduction.reason;
                document.getElementById('deductionNotes').value = deduction.notes || '';
                
                editingDeductionId = id;
                document.getElementById('cancelEditDeduction').style.display = 'inline-block';
                
                // التمرير إلى أعلى النموذج
                document.getElementById('deductionForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteDeduction(id) {
            if (confirm('هل أنت متأكد من حذف هذا الخصم؟')) {
                showLoading('جاري حذف الخصم...');
                
                deleteFromFirebase('deductions', id)
                    .then(() => {
                        showAlert('تم حذف الخصم بنجاح', 'success');
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء حذف الخصم', 'danger');
                        console.error('Error deleting deduction:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function resetDeductionForm() {
            document.getElementById('deductionForm').reset();
            document.getElementById('deductionDate').value = new Date().toISOString().split('T')[0];
            editingDeductionId = null;
            document.getElementById('cancelEditDeduction').style.display = 'none';
        }

        // المصروفات
        function saveExpense() {
            const date = document.getElementById('expenseDate').value;
            const description = document.getElementById('expenseDescription').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value;
            
            const expenseData = {
                date,
                description,
                amount,
                category
            };
            
            showLoading('جاري حفظ بيانات المصروف...');
            
            if (editingExpenseId) {
                // تعديل مصروف موجود
                saveToFirebase('expenses', expenseData, editingExpenseId)
                    .then(() => {
                        showAlert('تم تعديل المصروف بنجاح', 'success');
                        resetExpenseForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تعديل المصروف', 'danger');
                        console.error('Error updating expense:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            } else {
                // إضافة مصروف جديد
                saveToFirebase('expenses', expenseData)
                    .then(() => {
                        // خصم المبلغ من الخزينة تلقائياً
                        const cashTransactionData = {
                            date,
                            type: 'سحب',
                            amount,
                            description: `مصروف: ${description}`
                        };
                        
                        return saveToFirebase('cashTransactions', cashTransactionData);
                    })
                    .then(() => {
                        showAlert('تم تسجيل المصروف بنجاح وخصمه من الخزينة', 'success');
                        resetExpenseForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تسجيل المصروف', 'danger');
                        console.error('Error saving expense:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function displayExpenses() {
            const tbody = document.getElementById('expensesList');
            tbody.innerHTML = '';
            
            // ترتيب السجل من الأحدث إلى الأقدم
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedExpenses.forEach(expense => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(expense.date)}</td>
                    <td>${expense.description}</td>
                    <td>${expense.amount}</td>
                    <td>${expense.category}</td>
                    <td class="no-print">
                        <button onclick="editExpense('${expense.id}')">تعديل</button>
                        <button class="btn-danger" onclick="deleteExpense('${expense.id}')">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                document.getElementById('expenseDate').value = expense.date;
                document.getElementById('expenseDescription').value = expense.description;
                document.getElementById('expenseAmount').value = expense.amount;
                document.getElementById('expenseCategory').value = expense.category;
                
                editingExpenseId = id;
                document.getElementById('cancelEditExpense').style.display = 'inline-block';
                
                // التمرير إلى أعلى النموذج
                document.getElementById('expensesForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteExpense(id) {
            if (confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
                showLoading('جاري حذف المصروف...');
                
                const expense = expenses.find(e => e.id === id);
                
                deleteFromFirebase('expenses', id)
                    .then(() => {
                        // إعادة المبلغ إلى الخزينة عند حذف المصروف
                        if (expense) {
                            const cashTransactionData = {
                                date: new Date().toISOString().split('T')[0],
                                type: 'إيداع',
                                amount: expense.amount,
                                description: `إعادة مصروف: ${expense.description}`
                            };
                            
                            return saveToFirebase('cashTransactions', cashTransactionData);
                        }
                    })
                    .then(() => {
                        showAlert('تم حذف المصروف وإعادة المبلغ إلى الخزينة بنجاح', 'success');
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء حذف المصروف', 'danger');
                        console.error('Error deleting expense:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function resetExpenseForm() {
            document.getElementById('expensesForm').reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            editingExpenseId = null;
            document.getElementById('cancelEditExpense').style.display = 'none';
        }

        // خزينة العهدة
        function setInitialBalance() {
            const balanceInput = document.getElementById('initialBalance');
            const balance = parseFloat(balanceInput.value);
            
            if (isNaN(balance) || balance < 0) {
                showAlert('الرجاء إدخال رصيد صحيح', 'danger');
                return;
            }
            
            showLoading('جاري تعيين الرصيد الابتدائي...');
            
            // حفظ الرصيد الابتدائي
            database.ref('initialCashBalance').set(balance)
                .then(() => {
                    // تسجيل حركة الإيداع الابتدائي
                    const transactionData = {
                        date: new Date().toISOString().split('T')[0],
                        type: 'إيداع',
                        amount: balance,
                        description: 'رصيد ابتدائي للخزينة'
                    };
                    
                    return saveToFirebase('cashTransactions', transactionData);
                })
                .then(() => {
                    showAlert('تم تعيين الرصيد الابتدائي بنجاح', 'success');
                    balanceInput.value = '';
                })
                .catch((error) => {
                    showAlert('حدث خطأ أثناء تعيين الرصيد الابتدائي', 'danger');
                    console.error('Error setting initial balance:', error);
                })
                .finally(() => {
                    hideLoading();
                });
        }

        function saveCashTransaction() {
            const date = document.getElementById('transactionDate').value;
            const type = document.getElementById('transactionType').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const description = document.getElementById('transactionDescription').value;
            
            if (type === 'سحب') {
                const currentBalance = calculateCashBalance();
                if (amount > currentBalance) {
                    showAlert('المبلغ المطلوب سحبه أكبر من الرصيد المتاح في الخزينة', 'danger');
                    return;
                }
            }
            
            const transactionData = {
                date,
                type,
                amount,
                description
            };
            
            showLoading('جاري حفظ حركة الخزينة...');
            
            if (editingCashTransactionId) {
                // تعديل حركة موجودة
                saveToFirebase('cashTransactions', transactionData, editingCashTransactionId)
                    .then(() => {
                        showAlert('تم تعديل حركة الخزينة بنجاح', 'success');
                        resetCashTransactionForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تعديل حركة الخزينة', 'danger');
                        console.error('Error updating cash transaction:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            } else {
                // إضافة حركة جديدة
                saveToFirebase('cashTransactions', transactionData)
                    .then(() => {
                        showAlert('تم تسجيل حركة الخزينة بنجاح', 'success');
                        resetCashTransactionForm();
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء تسجيل حركة الخزينة', 'danger');
                        console.error('Error saving cash transaction:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function displayCashTransactions() {
            const tbody = document.getElementById('cashTransactionsList');
            tbody.innerHTML = '';
            
            // ترتيب السجل من الأحدث إلى الأقدم
            const sortedTransactions = [...cashTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedTransactions.forEach(transaction => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.type}</td>
                    <td>${transaction.amount}</td>
                    <td>${transaction.description}</td>
                    <td class="no-print">
                        <button onclick="editCashTransaction('${transaction.id}')">تعديل</button>
                        <button class="btn-danger" onclick="deleteCashTransaction('${transaction.id}')">حذف</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editCashTransaction(id) {
            const transaction = cashTransactions.find(t => t.id === id);
            if (transaction) {
                document.getElementById('transactionDate').value = transaction.date;
                document.getElementById('transactionType').value = transaction.type;
                document.getElementById('transactionAmount').value = transaction.amount;
                document.getElementById('transactionDescription').value = transaction.description;
                
                editingCashTransactionId = id;
                document.getElementById('cancelEditCash').style.display = 'inline-block';
                
                // التمرير إلى أعلى النموذج
                document.getElementById('cashTransactionForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteCashTransaction(id) {
            if (confirm('هل أنت متأكد من حذف هذه الحركة؟')) {
                showLoading('جاري حذف الحركة...');
                
                deleteFromFirebase('cashTransactions', id)
                    .then(() => {
                        showAlert('تم حذف الحركة بنجاح', 'success');
                    })
                    .catch((error) => {
                        showAlert('حدث خطأ أثناء حذف الحركة', 'danger');
                        console.error('Error deleting cash transaction:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }

        function resetCashTransactionForm() {
            document.getElementById('cashTransactionForm').reset();
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            editingCashTransactionId = null;
            document.getElementById('cancelEditCash').style.display = 'none';
        }

        function calculateCashBalance() {
            let balance = initialCashBalance;
            
            cashTransactions.forEach(transaction => {
                if (transaction.type === 'إيداع') {
                    balance += transaction.amount;
                } else if (transaction.type === 'سحب') {
                    balance -= transaction.amount;
                }
            });
            
            return balance;
        }

        function updateCashBalance() {
            const balance = calculateCashBalance();
            document.getElementById('cashBalanceAmount').textContent = balance.toFixed(2);
        }

        // تقارير المصروفات
        function generateExpenseReport() {
            const month = document.getElementById('expenseReportMonth').value;
            if (!month) {
                showAlert('الرجاء اختيار شهر', 'danger');
                return;
            }
            
            const reportResults = document.getElementById('expenseReportResults');
            reportResults.innerHTML = '';
            
            // تصفية المصروفات حسب الشهر
            const monthExpenses = expenses.filter(e => e.date.startsWith(month));
            
            if (monthExpenses.length === 0) {
                reportResults.innerHTML = '<div class="alert alert-danger">لا توجد مصروفات مسجلة لهذا الشهر</div>';
                return;
            }
            
            // حساب إجمالي المصروفات حسب الفئة
            const expensesByCategory = {};
            monthExpenses.forEach(expense => {
                if (!expensesByCategory[expense.category]) {
                    expensesByCategory[expense.category] = 0;
                }
                expensesByCategory[expense.category] += expense.amount;
            });
            
            // إحصائيات المصروفات
            const totalExpenses = monthExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            // عرض الإحصائيات
            const statsHTML = `
                <div class="stats-container">
                    <div class="stat-card">
                        <div>إجمالي المصروفات</div>
                        <div class="stat-value expenses">${totalExpenses.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div>عدد المصروفات</div>
                        <div class="stat-value">${monthExpenses.length}</div>
                    </div>
                </div>
            `;
            
            // عرض المصروفات حسب الفئة
            let categoriesHTML = '<h3>المصروفات حسب الفئة</h3><div class="salary-details">';
            for (const category in expensesByCategory) {
                categoriesHTML += `
                    <div class="salary-item">
                        <span>${category}:</span>
                        <span>${expensesByCategory[category].toFixed(2)}</span>
                    </div>
                `;
            }
            categoriesHTML += '</div>';
            
            // عرض تفاصيل المصروفات
            let detailsHTML = '<h3>تفاصيل المصروفات</h3><div class="table-container"><table><thead><tr><th>التاريخ</th><th>الوصف</th><th>المبلغ</th><th>الفئة</th></tr></thead><tbody>';
            
            monthExpenses.forEach(expense => {
                detailsHTML += `
                    <tr>
                        <td>${formatDate(expense.date)}</td>
                        <td>${expense.description}</td>
                        <td>${expense.amount}</td>
                        <td>${expense.category}</td>
                    </tr>
                `;
            });
            
            detailsHTML += '</tbody></table></div>';
            
            reportResults.innerHTML = statsHTML + categoriesHTML + detailsHTML;
        }

        // تقارير الخزينة
        function generateCashReport() {
            const month = document.getElementById('cashReportMonth').value;
            if (!month) {
                showAlert('الرجاء اختيار شهر', 'danger');
                return;
            }
            
            const reportResults = document.getElementById('cashReportResults');
            reportResults.innerHTML = '';
            
            // تصفية حركات الخزينة حسب الشهر
            const monthTransactions = cashTransactions.filter(t => t.date.startsWith(month));
            
            if (monthTransactions.length === 0) {
                reportResults.innerHTML = '<div class="alert alert-danger">لا توجد حركات مسجلة للخزينة في هذا الشهر</div>';
                return;
            }
            
            // حساب الإيداعات والسحوبات
            const deposits = monthTransactions.filter(t => t.type === 'إيداع');
            const withdrawals = monthTransactions.filter(t => t.type === 'سحب');
            
            const totalDeposits = deposits.reduce((sum, t) => sum + t.amount, 0);
            const totalWithdrawals = withdrawals.reduce((sum, t) => sum + t.amount, 0);
            const netCashFlow = totalDeposits - totalWithdrawals;
            
            // عرض الإحصائيات
            const statsHTML = `
                <div class="stats-container">
                    <div class="stat-card">
                        <div>إجمالي الإيداعات</div>
                        <div class="stat-value">${totalDeposits.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div>إجمالي السحوبات</div>
                        <div class="stat-value">${totalWithdrawals.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div>صافي التدفق النقدي</div>
                        <div class="stat-value">${netCashFlow.toFixed(2)}</div>
                    </div>
                </div>
            `;
            
            // عرض تفاصيل حركات الخزينة
            let detailsHTML = '<h3>تفاصيل حركات الخزينة</h3><div class="table-container"><table><thead><tr><th>التاريخ</th><th>نوع الحركة</th><th>المبلغ</th><th>الوصف</th></tr></thead><tbody>';
            
            monthTransactions.forEach(transaction => {
                detailsHTML += `
                    <tr>
                        <td>${formatDate(transaction.date)}</td>
                        <td>${transaction.type}</td>
                        <td>${transaction.amount}</td>
                        <td>${transaction.description}</td>
                    </tr>
                `;
            });
            
            detailsHTML += '</tbody></table></div>';
            
            reportResults.innerHTML = statsHTML + detailsHTML;
        }

        // تقرير نهاية الشهر
        function generateMonthlyReport() {
            const month = document.getElementById('reportMonth').value;
            if (!month) {
                showAlert('الرجاء اختيار شهر', 'danger');
                return;
            }
            
            const reportResults = document.getElementById('reportResults');
            reportResults.innerHTML = '';
            
            // إحصائيات عامة
            const monthAttendance = attendance.filter(a => a.date.startsWith(month));
            const monthAdvances = advances.filter(a => a.date.startsWith(month));
            const monthBonuses = bonuses.filter(b => b.date.startsWith(month));
            const monthDeductions = deductions.filter(d => d.date.startsWith(month));
            
            // إحصائيات الموظفين
            let totalSalaries = 0;
            let totalAdvances = 0;
            let totalBonuses = 0;
            let totalDeductions = 0;
            
            const employeeReports = [];
            currentReportData = [];
            
            employees.forEach(employee => {
                // حساب أيام الحضور والغياب والإجازة
                const employeeAttendance = monthAttendance.filter(a => a.employeeId === employee.id);
                const presenceDays = employeeAttendance.filter(a => a.status === 'حضور').length;
                const absenceDays = employeeAttendance.filter(a => a.status === 'غياب').length;
                const vacationDays = employeeAttendance.filter(a => a.status === 'إجازة').length;
                
                // حساب سعر اليوم بناءً على 30 يوم
                const dailyRate = employee.salary / 30;
                
                // حساب الراتب الأساسي
                const baseSalary = dailyRate * presenceDays;
                
                // حساب السلف
                const employeeAdvances = monthAdvances.filter(a => a.employeeId === employee.id);
                const totalEmployeeAdvances = employeeAdvances.reduce((sum, advance) => sum + advance.amount, 0);
                
                // حساب المكافآت
                const employeeBonuses = monthBonuses.filter(b => b.employeeId === employee.id);
                const totalEmployeeBonuses = employeeBonuses.reduce((sum, bonus) => sum + bonus.amount, 0);
                
                // حساب الخصومات
                const employeeDeductions = monthDeductions.filter(d => d.employeeId === employee.id);
                const totalEmployeeDeductions = employeeDeductions.reduce((sum, deduction) => sum + deduction.amount, 0);
                
                // حساب صافي الراتب
                const netSalary = baseSalary + totalEmployeeBonuses - totalEmployeeAdvances - totalEmployeeDeductions;
                
                // تحديث الإجماليات
                totalSalaries += netSalary;
                totalAdvances += totalEmployeeAdvances;
                totalBonuses += totalEmployeeBonuses;
                totalDeductions += totalEmployeeDeductions;
                
                // تخزين بيانات الموظف للتقرير
                currentReportData.push({
                    "اسم الموظف": employee.name,
                    "الوظيفة": employee.position,
                    "الراتب الشهري": employee.salary,
                    "سعر اليوم (30 يوم)": dailyRate.toFixed(2),
                    "أيام الحضور": presenceDays,
                    "أيام الغياب": absenceDays,
                    "أيام الإجازة": vacationDays,
                    "الراتب الأساسي": baseSalary.toFixed(2),
                    "إجمالي السلف": totalEmployeeAdvances.toFixed(2),
                    "إجمالي المكافآت": totalEmployeeBonuses.toFixed(2),
                    "إجمالي الخصومات": totalEmployeeDeductions.toFixed(2),
                    "صافي الراتب": netSalary.toFixed(2)
                });
                
                // إضافة تقرير الموظف
                employeeReports.push(`
                    <div class="employee-report">
                        <h3>${employee.name} - ${employee.position}</h3>
                        <div class="salary-calculation">
                            <div class="salary-details">
                                <div class="salary-item">
                                    <span>الراتب الشهري:</span>
                                    <span>${employee.salary.toFixed(2)}</span>
                                </div>
                                <div class="salary-item">
                                    <span>سعر اليوم (30 يوم):</span>
                                    <span>${dailyRate.toFixed(2)}</span>
                                </div>
                                <div class="salary-item">
                                    <span>أيام الحضور:</span>
                                    <span>${presenceDays}</span>
                                </div>
                                <div class="salary-item">
                                    <span>أيام الغياب:</span>
                                    <span>${absenceDays}</span>
                                </div>
                                <div class="salary-item">
                                    <span>أيام الإجازة:</span>
                                    <span>${vacationDays}</span>
                                </div>
                                <div class="salary-item">
                                    <span>الراتب الأساسي:</span>
                                    <span>${baseSalary.toFixed(2)}</span>
                                </div>
                                <div class="salary-item">
                                    <span>إجمالي السلف:</span>
                                    <span>- ${totalEmployeeAdvances.toFixed(2)}</span>
                                </div>
                                <div class="salary-item">
                                    <span>إجمالي المكافآت:</span>
                                    <span>+ ${totalEmployeeBonuses.toFixed(2)}</span>
                                </div>
                                <div class="salary-item">
                                    <span>إجمالي الخصومات:</span>
                                    <span>- ${totalEmployeeDeductions.toFixed(2)}</span>
                                </div>
                                <div class="salary-item salary-total">
                                    <span>صافي الراتب:</span>
                                    <span>${netSalary.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            });
            
            // عرض الإحصائيات العامة
            const statsHTML = `
                <div class="stats-container">
                    <div class="stat-card">
                        <div>عدد الموظفين</div>
                        <div class="stat-value">${employees.length}</div>
                    </div>
                    <div class="stat-card">
                        <div>إجمالي الرواتب</div>
                        <div class="stat-value">${totalSalaries.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div>إجمالي السلف</div>
                        <div class="stat-value advance">${totalAdvances.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div>إجمالي المكافآت</div>
                        <div class="stat-value bonus">${totalBonuses.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div>إجمالي الخصومات</div>
                        <div class="stat-value deduction">${totalDeductions.toFixed(2)}</div>
                    </div>
                </div>
            `;
            
            // عرض تقارير الموظفين
            const employeesHTML = employeeReports.join('');
            
            // عرض الملخص النهائي
            const summaryHTML = `
                <div class="summary">
                    <h3>ملخص التقرير الشهري</h3>
                    <div class="salary-details">
                        <div class="salary-item">
                            <span>إجمالي الرواتب:</span>
                            <span>${totalSalaries.toFixed(2)}</span>
                        </div>
                        <div class="salary-item salary-total">
                            <span>إجمالي التكاليف:</span>
                            <span>${totalSalaries.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            reportResults.innerHTML = statsHTML + employeesHTML + summaryHTML;
        }

        // تصدير التقارير إلى Excel
        function exportReportToExcel() {
            if (currentReportData.length === 0) {
                showAlert('لا توجد بيانات للتصدير. يرجى إنشاء التقرير أولاً.', 'danger');
                return;
            }
            
            const month = document.getElementById('reportMonth').value;
            const ws = XLSX.utils.json_to_sheet(currentReportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "تقرير الموظفين");
            XLSX.writeFile(wb, `تقرير_الموظفين_${month}.xlsx`);
            
            showAlert('تم تصدير التقرير بنجاح', 'success');
        }

        function exportExpenseReportToExcel() {
            const month = document.getElementById('expenseReportMonth').value;
            const monthExpenses = expenses.filter(e => e.date.startsWith(month));
            
            if (monthExpenses.length === 0) {
                showAlert('لا توجد مصروفات للتصدير', 'danger');
                return;
            }
            
            const expenseData = monthExpenses.map(expense => ({
                "التاريخ": formatDate(expense.date),
                "الوصف": expense.description,
                "المبلغ": expense.amount,
                "الفئة": expense.category
            }));
            
            const ws = XLSX.utils.json_to_sheet(expenseData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "تقرير المصروفات");
            XLSX.writeFile(wb, `تقرير_المصروفات_${month}.xlsx`);
            
            showAlert('تم تصدير تقرير المصروفات بنجاح', 'success');
        }

        function exportCashReportToExcel() {
            const month = document.getElementById('cashReportMonth').value;
            const monthTransactions = cashTransactions.filter(t => t.date.startsWith(month));
            
            if (monthTransactions.length === 0) {
                showAlert('لا توجد حركات للتصدير', 'danger');
                return;
            }
            
            const cashData = monthTransactions.map(transaction => ({
                "التاريخ": formatDate(transaction.date),
                "نوع الحركة": transaction.type,
                "المبلغ": transaction.amount,
                "الوصف": transaction.description
            }));
            
            const ws = XLSX.utils.json_to_sheet(cashData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "تقرير الخزينة");
            XLSX.writeFile(wb, `تقرير_الخزينة_${month}.xlsx`);
            
            showAlert('تم تصدير تقرير الخزينة بنجاح', 'success');
        }

        // تصدير بيانات الموظفين إلى Excel
        function exportEmployeesToExcel() {
            if (employees.length === 0) {
                showAlert('لا توجد بيانات موظفين للتصدير', 'danger');
                return;
            }
            
            const employeeData = employees.map(employee => ({
                "اسم الموظف": employee.name,
                "رقم الجوال": employee.phone,
                "الوظيفة": employee.position,
                "الراتب الشهري": employee.salary,
                "أيام العمل": employee.workingDays,
                "أيام الإجازة": employee.vacationDays
            }));
            
            const ws = XLSX.utils.json_to_sheet(employeeData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "بيانات الموظفين");
            XLSX.writeFile(wb, "بيانات_الموظفين.xlsx");
            
            showAlert('تم تصدير بيانات الموظفين بنجاح', 'success');
        }

        // أدوات مساعدة
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG');
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            document.querySelector('.container').insertBefore(alert, document.querySelector('header'));
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        function showLoading(message = 'جاري التحميل...') {
            // يمكن إضافة مؤشر تحميل هنا
            console.log(message);
        }

        function hideLoading() {
            // يمكن إخفاء مؤشر التحميل هنا
        }

        function exportToExcel(tableId, filename) {
            const table = document.getElementById(tableId);
            const wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"});
            XLSX.writeFile(wb, `${filename}.xlsx`);
        }
    </script>
</body>
</html>
